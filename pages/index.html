<!DOCTYPE html>
<html>
  <head>
    <title>Dash</title>
    <meta charset="UTF-8">
    <meta name="author" content="Jack Sarick">
    <style type="text/css">
      <<< /css/bulma.min.css >>>
      <<< /css/layout.css >>>
    </style>
    <script type="text/javascript">
      <<< /js/charts.min.js >>>
      <<< /js/colours.js >>>
      <<< /js/jackQuery.js >>>

      sum = x => x.reduce((a, b) => a + b, 0)

      const sum_data = <<< /data/aggregate.json >>>;

      const country_names = ["North America", "Europe", "Asia"]
      const country_code = ["NA", "EU", "AS"]

      // Doctor the data
      agg_data = sum_data.map(arr =>
        arr.data
      )

      contains = (arr, x) => Object.keys(arr).filter(k => arr[k] == x).length > 0

      // Format it
      country_data = []
      country_data = country_data.concat(agg_data[0].map(d => {
        d["country"] = country_code[0]
        return d
      }))

      country_data = country_data.concat(agg_data[1].map(d => {
        d["country"] = country_code[1]
        return d
      }))

      country_data = country_data.concat(agg_data[2].map(d => {
        d["country"] = country_code[2]
        return d
      }))

      function impression_count(axis1, axis2) {
        return (axis1 == undefined)? sum(country_data.map(p => p.impressions)) : (axis2 != undefined)? sum(country_data.filter(d =>
                  contains(d, axis1) && contains(d, axis2)
                ).map(p => p.impressions)) : sum(country_data.filter(d =>
                  contains(d, axis1)
                ).map(p => p.impressions))
      }
    </script>
  </head>
  <body>

    <!-- Main Header -->
    <section class="hero is-primary is-bold">
      <div class="hero-body">
        <div class="container">
          <div class="columns">
            <div class="column one-quarter">
              <img src="https://placehold.it/400x100?text=Playground+by+Rush" alt="">
            </div>
            <div class="column">
            </div>
            <div class="column is-1">
             <a class="button is-info is-outlined is-large">Account</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Rest of the page -->
    <section class="section columns charts">
      <!-- Info -->
      <div class="column is-one-half">
        <center><h1 class="title is-1">Explore Our Data</h1></center>
        <div class="buffer"></div>
        <h2 class="title is-2">
          <b id="user-count">XXX</b> people from <<< /options/country.html >>> saw a <<< /options/format.html >>> ad on a <<< /options/device.html >>>
        </h2>

        <h2 class="title is-2">
          Our data shows the most effective vector was <b id="device-auto">XXX</b> <b id="format-auto">XXX</b> ads in <b id="country-auto">XXX</b>, as it was seen by <b id="user-count-auto">XXX</b> people
        </h2>

        <div class="buffer"></div>

        <h3 class="title is-3">
          Let us help you launch the most effective ad campaign you possibly can. You'll save money, reach a more valuable audience, and we'll always break it down to plain english for you.
        </h3>
      </div>
      
      <!-- Main Graph -->
      <div class="column is-one-half">
        <div class="buffer"></div>
        <canvas id="bubble-chart"></canvas>

        <select id="axis-one">
          <option value='["mobile", "desktop", "app"]'>Device</option>
          <option value='["NA", "EU", "AS"]'>Country</option>
          <option value='["video", "banner"]'>Format</option>
        </select>

        <b>VS.</b>

        <select id="axis-two">
          <option value='["mobile", "desktop", "app"]'>Device</option>
          <option value='["NA", "EU", "AS"]'>Country</option>
          <option value='["video", "banner"]'>Format</option>
        </select>

        <script type="text/javascript">
          draw_bubble_chart = () => {
            var ctx = document.getElementById("bubble-chart");
            const axis_one = JSON.parse($("#axis-one").value())
            const axis_two = JSON.parse($("#axis-two").value())

            data_set = []

            for (var i = axis_one.length - 1; i >= 0; i--) {
              for (var n = axis_two.length - 1; n >= 0; n--) {
                data_set.push({
                  x: i,
                  y: n,
                  r: impression_count(axis_one[i], axis_two[n])/1000000
                })
              }
            }

            var data = {

              datasets: [{
                label: "Impressions",
                data: data_set,
                backgroundColor: colour.green,
              }]
            };

            var bubbleChart = new Chart(ctx,{
              type: 'bubble',
              data: data
            });
          }
        </script>
      </div>
    </section>

    <script type="text/javascript">
      window.onload = function() {
        percent = Math.floor((sum(agg_data.map(f => f.impressions)) / {{{ ideal-impressions }}}) * 100)

        updateUserCount()
        optimalAd()
        draw_bubble_chart()

        $("#progress").value(percent)
        $("#progress").html(percent + "%")
        $("#percentage").html(percent + "%")
      }

      $("#country-select").listen("change", updateUserCount);
      $("#device-select").listen("change", updateUserCount);
      $("#format-select").listen("change", updateUserCount);
      $("#axis-one").listen("change", draw_bubble_chart);
      $("#axis-two").listen("change", draw_bubble_chart);

      function updateUserCount() {
        $("#user-count").html(sum(agg_data[$("#country-select").value()]
                  .filter(dp =>
                    (dp.platform == $("#device-select").value()) &&
                    (dp.format == $("#format-select").value()))
                  .map(di => di.impressions)).toLocaleString())
      }

      listify = (l) => Array.apply(null, $(l).$.options).map(f => f.value)
      function optimalAd() {
        countries = listify("#country-select")
        devices = listify("#device-select")
        formats = listify("#format-select")

        max = 0
        optimal = []

        // Highly advanced optimization algorithm
        for (var i = countries.length - 1; i >= 0; i--) {
          for (var k = devices.length - 1; k >= 0; k--) {
            for (var n = formats.length - 1; n >= 0; n--) {
              count = sum(agg_data[countries[i]]
                  .filter(dp =>
                    (dp.platform == devices[k]) &&
                    (dp.format == formats[n]))
                  .map(di => di.impressions))
              if (count > max) {
                max = count
                optimal = [countries[i], devices[k], formats[n]];
              }
            }
          }
        }

        $("#country-auto").html(country_names[optimal[0]])
        $("#device-auto").html(optimal[1])
        $("#format-auto").html(optimal[2])
        $("#user-count-auto").html(max.toLocaleString())

      }
    </script>
  </body>
</html>
